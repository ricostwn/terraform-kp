# Ansible Configuration Guide

This guide explains how Ansible is used to configure the scalable web server infrastructure.

## Overview

Ansible automatically configures:
- **Monitoring Server**: Prometheus, Grafana, and Nginx Load Balancer
- **Web Servers**: Node.js applications and Node Exporter for metrics

## Playbook Structure

### Main Playbook (`playbook.yml`)

The main playbook consists of three main sections:

1. **Common Setup** (`hosts: all`)
   - Updates system packages
   - Installs Docker and essential tools
   - Creates application directories

2. **Monitoring Server** (`hosts: monitoring_server`)
   - Configures Prometheus with dynamic targets
   - Sets up Grafana with default credentials
   - Configures Nginx load balancer

3. **Web Servers** (`hosts: web_servers`)
   - Deploys Node.js application
   - Installs Node Exporter for metrics
   - Starts services with Docker Compose

### Inventory Template (`inventory.tpl`)

Terraform generates the inventory dynamically:
```ini
[monitoring_server]
monitoring ansible_host=<external_ip> ansible_user=<user> internal_ip=<internal_ip>

[web_servers]
web-server-1 ansible_host=<external_ip> ansible_user=<user> internal_ip=<internal_ip>
web-server-2 ansible_host=<external_ip> ansible_user=<user> internal_ip=<internal_ip>
```

## Configuration Details

### Docker Compose Services

#### Monitoring Server Services:
- **Prometheus** (port 9090): Metrics collection and alerting
- **Grafana** (port 3000): Visualization dashboards
- **Nginx** (port 80): Load balancer and reverse proxy

#### Web Server Services:
- **Web Application** (port 3000): Node.js application
- **Node Exporter** (port 9100): System metrics collection

### Prometheus Configuration

Dynamic configuration based on web server inventory:
```yaml
scrape_configs:
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['<web-server-1-ip>:9100', '<web-server-2-ip>:9100']
  
  - job_name: 'web-servers'
    static_configs:
      - targets: ['<web-server-1-ip>:3000', '<web-server-2-ip>:3000']
```

### Nginx Load Balancer

Round-robin load balancing across web servers:
```nginx
upstream web_servers {
    server <web-server-1-ip>:3000;
    server <web-server-2-ip>:3000;
}

server {
    listen 80;
    location / {
        proxy_pass http://web_servers;
    }
}
```

## Manual Ansible Execution

### Prerequisites
- Ansible installed on your local machine
- SSH access to all servers
- Inventory file generated by Terraform

### Run Full Playbook
```powershell
cd ansible
ansible-playbook -i inventory.ini playbook.yml
```

### Run Specific Tasks
```powershell
# Only configure monitoring server
ansible-playbook -i inventory.ini playbook.yml --limit monitoring_server

# Only configure web servers
ansible-playbook -i inventory.ini playbook.yml --limit web_servers

# Run with specific tags (if implemented)
ansible-playbook -i inventory.ini playbook.yml --tags docker,monitoring
```

### Test Connectivity
```powershell
# Test all servers
ansible all -i inventory.ini -m ping

# Test specific group
ansible web_servers -i inventory.ini -m ping

# Run ad-hoc commands
ansible all -i inventory.ini -a "docker ps"
ansible all -i inventory.ini -a "systemctl status docker"
```

## Troubleshooting

### Common Issues

1. **SSH Connection Refused**
   ```powershell
   # Test SSH manually
   ssh -i ~/.ssh/id_ed25519 user@server-ip
   
   # Check SSH agent
   ssh-add ~/.ssh/id_ed25519
   ```

2. **Ansible Facts Gathering Failed**
   ```powershell
   # Disable facts gathering for testing
   ansible-playbook -i inventory.ini playbook.yml --extra-vars "gather_facts=no"
   ```

3. **Docker Permission Denied**
   ```powershell
   # Check if user is in docker group
   ansible all -i inventory.ini -a "groups $USER"
   
   # Manually add user to docker group
   ansible all -i inventory.ini -b -a "usermod -aG docker $USER"
   ```

4. **Services Not Starting**
   ```powershell
   # Check service logs
   ansible all -i inventory.ini -a "docker logs prometheus"
   ansible all -i inventory.ini -a "docker logs grafana"
   ansible all -i inventory.ini -a "docker logs nginx-lb"
   ```

### Debug Mode

Run playbook with verbose output:
```powershell
# Verbose mode
ansible-playbook -i inventory.ini playbook.yml -v

# Very verbose mode
ansible-playbook -i inventory.ini playbook.yml -vvv

# Debug mode
ansible-playbook -i inventory.ini playbook.yml --step --diff
```

### Check Configuration

Verify configurations on servers:
```powershell
# Check Prometheus config
ansible monitoring_server -i inventory.ini -a "cat /opt/monitoring/prometheus/prometheus.yml"

# Check Nginx config
ansible monitoring_server -i inventory.ini -a "cat /opt/monitoring/nginx/default.conf"

# Check running containers
ansible all -i inventory.ini -a "docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'"
```

## Customization

### Modify Web Application

To deploy a different application, modify the playbook:

1. Change the `app.js` content in the web servers section
2. Update `package.json` dependencies
3. Modify `Dockerfile` if needed
4. Update port mappings in docker-compose

### Add More Services

To add additional services:

1. Add new tasks to the appropriate host group
2. Update firewall rules in Terraform
3. Add service discovery to Prometheus configuration
4. Create corresponding Grafana dashboards

### Environment Variables

Pass variables to the playbook:
```powershell
ansible-playbook -i inventory.ini playbook.yml --extra-vars "app_port=8080 app_env=production"
```

### Vault for Secrets

For production, use Ansible Vault for sensitive data:
```powershell
# Create encrypted file
ansible-vault create secrets.yml

# Run with vault
ansible-playbook -i inventory.ini playbook.yml --ask-vault-pass
```

## Integration with Terraform

### Automatic Execution

Terraform automatically runs Ansible after infrastructure deployment:
1. Creates instances
2. Generates inventory file
3. Executes Ansible playbook
4. Reports deployment status

### Manual Re-run

If you need to re-run Ansible without Terraform:
```powershell
# Re-run full configuration
cd ansible
ansible-playbook -i inventory.ini playbook.yml

# Update only monitoring configuration
ansible-playbook -i inventory.ini playbook.yml --limit monitoring_server
```

### Scaling Considerations

When scaling web servers:
1. Terraform updates instance count
2. Generates new inventory
3. Ansible reconfigures Prometheus targets
4. Nginx upstream configuration updates
5. Services restart with new configuration

## Best Practices

1. **Idempotency**: All tasks should be idempotent
2. **Error Handling**: Use proper error handling and retries
3. **Logging**: Enable logging for troubleshooting
4. **Testing**: Test playbooks in staging environment
5. **Documentation**: Keep playbooks well-documented
6. **Version Control**: Use Git for playbook versioning
7. **Security**: Use Ansible Vault for sensitive data

## Monitoring Ansible Execution

### Log Files
- Ansible logs: `/var/log/ansible.log` (if configured)
- Application logs: `docker logs <container-name>`
- System logs: `journalctl -u docker`

### Metrics Collection
Monitor Ansible execution through:
- Execution time metrics
- Task success/failure rates
- Infrastructure drift detection
- Configuration compliance checks

---

This guide provides comprehensive information for managing the Ansible configuration. For additional help, refer to the main README.md file.
